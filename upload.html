<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sube tu dise√±o - MSA Shop</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .upload-container {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      max-width: 500px;
      margin: 50px auto;
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }
    #previewImg {
      max-width: 300px;
      margin: 15px 0;
      border-radius: 10px;
      display: none;
      border: 3px solid #3498db;
    }
    .upload-input {
      margin: 20px 0;
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      background: rgba(255,255,255,0.9);
      border: 2px dashed #3498db;
      border-radius: 10px;
      cursor: pointer;
    }
    .upload-input:hover {
      background: rgba(255,255,255,1);
    }
    .info-pedido {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
      text-align: left;
      border-left: 4px solid #f39c12;
    }
    .loading {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .file-info {
      color: #f39c12;
      margin: 10px 0;
      font-size: 14px;
      font-weight: bold;
    }
    .panda-decoracion {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 120px;
      height: 120px;
      opacity: 0.85;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(255,255,255,0.7);
      object-fit: cover;
      transition: transform 0.3s ease;
      cursor: pointer;
      z-index: 100;
    }
    .panda-decoracion:hover { 
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 0 25px rgba(255,255,255,0.9);
    }
    .debug-info {
      background: rgba(52, 152, 219, 0.2);
      padding: 12px;
      border-radius: 10px;
      margin: 15px 0;
      font-size: 13px;
      color: #3498db;
      border-left: 4px solid #3498db;
    }
    .color-indicator {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 8px;
      vertical-align: middle;
      border: 2px solid #fff;
    }
    .requisitos {
      background: rgba(231, 76, 60, 0.2);
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 12px;
      color: #e74c3c;
      border-left: 4px solid #e74c3c;
    }
    .success-message {
      background: rgba(46, 204, 113, 0.2);
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      color: #2ecc71;
      border-left: 4px solid #2ecc71;
    }
  </style>
</head>
<body>
  <header>
    <h1>Sube tu dise√±o</h1>
    <div style="position: absolute; top: 20px; right: 30px;">
      <button onclick="volverAlInicio()" style="background: #3498db; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
        ‚Üê Volver al Inicio
      </button>
    </div>
  </header>

  <main>
    <div class="upload-container">
      <h2>üé® Personaliza tu Camisa</h2>
      
      <div class="info-pedido">
        <p><strong>üì¶ Producto:</strong> Camisa Personalizada</p>
        <p><strong>üé® Color:</strong> <span id="color-info">?</span></p>
        <p><strong>üìè Talla:</strong> <span id="talla-info">?</span></p>
        <p><strong>üí∞ Precio:</strong> $250 MXN</p>
      </div>

      <div class="debug-info" id="debugInfo">
        üîç <strong>Estado:</strong> Listo para subir dise√±o...
      </div>

      <div class="requisitos">
        ‚ö†Ô∏è <strong>Requisitos:</strong> 
        <br>‚Ä¢ Formatos: PNG, JPG, JPEG
        <br>‚Ä¢ Tama√±o m√°ximo: 5MB
        <br>‚Ä¢ Resoluci√≥n recomendada: 1000x1000px
      </div>
      
      <input type="file" id="fileInput" accept=".png,.jpg,.jpeg" class="upload-input">
      <div id="fileInfo" class="file-info"></div>
      
      <div id="previewContainer" style="display: none;">
        <h3>üëÄ Vista Previa:</h3>
        <img id="previewImg" src="" alt="Vista previa de tu dise√±o">
      </div>
      
      <br>
      <button id="enviarBtn" class="comprar-btn" style="margin-top: 20px;">
        üöÄ Enviar dise√±o y confirmar pedido
      </button>

      <div id="successMessage" class="success-message" style="display: none;">
        ‚úÖ ¬°Dise√±o enviado exitosamente! Redirigiendo...
      </div>
    </div>
  </main>

  <!-- Panda decorativo -->
  <img src="img/panda.png" alt="Panda MSA" class="panda-decoracion" onclick="volverAlInicio()" title="¬°Haz clic para volver al inicio! üè†">

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <script>
    // Funci√≥n para volver al inicio
    function volverAlInicio() {
      const panda = document.querySelector('.panda-decoracion');
      if (panda) {
        panda.style.transform = 'scale(0.9) rotate(-10deg)';
        panda.style.opacity = '0.7';
      }
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 300);
    }

    // ‚öôÔ∏è CONFIGURACI√ìN CLOUDINARY
    const CLOUDINARY_CLOUD_NAME = 'dnzcup3ze';
    const CLOUDINARY_UPLOAD_PRESET = 'msa_shop_upload';

    // Mapeo de colores
    const colorMap = {
      'blanco': { nombre: 'Blanco', clase: 'color-blanco' },
      'negro': { nombre: 'Negro', clase: 'color-negro' },
      'gris': { nombre: 'Gris', clase: 'color-gris' }
    };

    // Elementos DOM
    const urlParams = new URLSearchParams(window.location.search);
    const talla = urlParams.get('talla') || localStorage.getItem('tallaSeleccionada') || 'No especificada';
    const color = urlParams.get('color') || localStorage.getItem('colorSeleccionado') || 'No especificado';

    const fileInput = document.getElementById('fileInput');
    const previewImg = document.getElementById('previewImg');
    const previewContainer = document.getElementById('previewContainer');
    const enviarBtn = document.getElementById('enviarBtn');
    const fileInfo = document.getElementById('fileInfo');
    const debugInfo = document.getElementById('debugInfo');
    const successMessage = document.getElementById('successMessage');

    let archivoSeleccionado = null;

    // Mostrar informaci√≥n del pedido
    function mostrarInfoPedido() {
      const colorInfo = document.getElementById('color-info');
      const tallaInfo = document.getElementById('talla-info');
      
      const colorData = colorMap[color] || { nombre: color, clase: 'color-gris' };
      
      colorInfo.innerHTML = `<span class="color-indicator ${colorData.clase}"></span>${colorData.nombre}`;
      tallaInfo.textContent = talla;
    }

    // Actualizar info de debug
    function actualizarDebug(mensaje) {
      debugInfo.innerHTML = `üîç <strong>Estado:</strong> ${mensaje}`;
      console.log('üîç Debug:', mensaje);
    }

    // Inicializar p√°gina
    function inicializarPagina() {
      mostrarInfoPedido();
      actualizarDebug(`Pedido: Camisa ${colorMap[color]?.nombre || color} - Talla ${talla}`);
    }

    // Configurar evento del file input
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      // Verificar tama√±o m√°ximo
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('‚ùå La imagen es demasiado grande. M√°ximo 5MB permitido.');
        fileInput.value = '';
        fileInfo.textContent = '';
        actualizarDebug('Archivo demasiado grande - m√°ximo 5MB');
        return;
      }

      if (!['image/png', 'image/jpeg', 'image/jpg'].includes(file.type)) {
        alert('‚ùå Solo se permiten archivos PNG, JPG o JPEG');
        fileInput.value = '';
        fileInfo.textContent = '';
        actualizarDebug('Formato de archivo no v√°lido');
        return;
      }

      archivoSeleccionado = file;
      
      // Mostrar informaci√≥n del archivo
      const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
      fileInfo.textContent = `üìÅ ${file.name} (${sizeMB} MB)`;
      actualizarDebug(`Archivo listo: ${file.name} (${sizeMB} MB)`);
      
      // Mostrar vista previa
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        previewContainer.style.display = 'block';
        actualizarDebug('Vista previa generada');
      };
      reader.readAsDataURL(file);
    });

    // Funci√≥n para subir imagen a Cloudinary
    async function subirACloudinary(archivo) {
      actualizarDebug('‚òÅÔ∏è Iniciando subida a Cloudinary...');
      
      const formData = new FormData();
      formData.append('file', archivo);
      formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      
      const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;

      try {
        const response = await fetch(url, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Cloudinary error ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        actualizarDebug('‚úÖ Imagen subida a Cloudinary exitosamente');
        return data.secure_url;

      } catch (error) {
        console.error('‚ùå Error Cloudinary:', error);
        actualizarDebug(`‚ùå Error Cloudinary: ${error.message}`);
        throw error;
      }
    }

    // Funci√≥n alternativa: Convertir imagen a Base64 peque√±o
    function imagenABase64Pequeno(archivo, maxWidth = 400) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const img = new Image();
          
          img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
              height = Math.round((height * maxWidth) / width);
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            const base64 = canvas.toDataURL('image/jpeg', 0.5);
            resolve(base64);
          };

          img.onerror = reject;
          img.src = e.target.result;
        };

        reader.onerror = reject;
        reader.readAsDataURL(archivo);
      });
    }

    // Funci√≥n principal para enviar el pedido
    enviarBtn.addEventListener('click', async function() {
      if (!archivoSeleccionado) {
        alert('‚ùå Por favor selecciona un archivo primero');
        return;
      }

      // Obtener datos del usuario
      const userData = JSON.parse(localStorage.getItem('userData') || '{}');

      // Deshabilitar bot√≥n y mostrar loading
      enviarBtn.textContent = '‚è≥ Procesando...';
      enviarBtn.disabled = true;
      enviarBtn.classList.add('loading');

      try {
        let imagenUrl = '';
        let metodoSubida = '';

        // INTENTAR CLOUDINARY PRIMERO
        try {
          actualizarDebug('üîÑ Intentando subir a Cloudinary...');
          enviarBtn.textContent = '‚òÅÔ∏è Subiendo a Cloudinary...';
          imagenUrl = await subirACloudinary(archivoSeleccionado);
          metodoSubida = 'cloudinary';
          actualizarDebug('‚úÖ Cloudinary exitoso - imagen subida');
        } catch (cloudinaryError) {
          console.warn('‚ö†Ô∏è Cloudinary fall√≥, intentando Base64...', cloudinaryError);
          
          // FALLBACK: Usar Base64 comprimido
          try {
            actualizarDebug('üîÑ Fallback: Comprimiendo imagen...');
            enviarBtn.textContent = 'üìê Comprimiendo imagen...';
            imagenUrl = await imagenABase64Pequeno(archivoSeleccionado, 300);
            metodoSubida = 'base64';
            actualizarDebug('‚úÖ Imagen comprimida a Base64');
          } catch (base64Error) {
            console.error('‚ùå Base64 tambi√©n fall√≥:', base64Error);
            imagenUrl = `Archivo: ${archivoSeleccionado.name} (No se pudo procesar la imagen)`;
            metodoSubida = 'error';
            actualizarDebug('‚ö†Ô∏è Usando descripci√≥n en lugar de imagen');
          }
        }

        // Preparar datos para el email
        const colorData = colorMap[color] || { nombre: color };
        
        const templateParams = {
          nombre: userData.nombre || "Cliente MSA",
          email: userData.email || "cliente@msashop.com",
          productos: `Camisa Personalizada - Color: ${colorData.nombre} - Talla: ${talla}`,
          total: "$250 MXN",
          fecha: new Date().toLocaleDateString('es-MX'),
          direccion: userData.direccion || "No especificada",
          ciudad: "Guadalajara",
          codigo_postal: "45000",
          telefono: userData.telefono || "No proporcionado",
          imagen_url: imagenUrl,
          metodo_subida: metodoSubida,
          mensaje_adicional: `El cliente ha solicitado una camisa personalizada con las siguientes especificaciones:
          
Color: ${colorData.nombre}
Talla: ${talla}
Archivo de dise√±o: ${archivoSeleccionado.name}
          
Por favor contactar al cliente para confirmar detalles del dise√±o.`
        };

        actualizarDebug('üìß Preparando env√≠o de email...');
        enviarBtn.textContent = 'üì§ Enviando email...';

        // Inicializar y enviar con EmailJS
        await emailjs.init("PhV4Hp36EPOLiGe6t");
        const resultado = await emailjs.send("service_4450mrz", "template_biyacaa", templateParams);

        console.log('‚úÖ Email enviado exitosamente:', resultado);
        actualizarDebug('‚úÖ Pedido completado y email enviado');
        
        // Mostrar mensaje de √©xito
        successMessage.style.display = 'block';
        enviarBtn.style.display = 'none';
        
        let mensajeExito = '';
        if (metodoSubida === 'cloudinary') {
          mensajeExito = '‚úÖ ¬°Pedido confirmado! Se ha enviado el dise√±o COMPLETO por email.';
        } else if (metodoSubida === 'base64') {
          mensajeExito = '‚úÖ ¬°Pedido confirmado! Se ha enviado el dise√±o (imagen comprimida) por email.';
        } else {
          mensajeExito = '‚úÖ ¬°Pedido confirmado! Se ha enviado la informaci√≥n del pedido.';
        }
        
        alert(mensajeExito);
        
        // Redirigir despu√©s de 3 segundos
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 3000);

      } catch (error) {
        console.error('‚ùå Error completo:', error);
        actualizarDebug(`‚ùå Error final: ${error.message}`);
        
        let mensajeError = 'Error al enviar el pedido: ';
        
        if (error.message.includes('Cloudinary')) {
          mensajeError += 'Problema con el servicio de im√°genes. ';
        }
        
        if (error.status === 413) {
          mensajeError += 'La imagen es demasiado grande. Intenta con un archivo m√°s peque√±o.';
        } else {
          mensajeError += error.text || error.message || 'Error desconocido';
        }
        
        alert('‚ùå ' + mensajeError);
        
        // Restaurar bot√≥n
        enviarBtn.textContent = 'üöÄ Enviar dise√±o y confirmar pedido';
        enviarBtn.disabled = false;
        enviarBtn.classList.remove('loading');
      }
    });

    // Inicializar la p√°gina cuando cargue
    document.addEventListener('DOMContentLoaded', function() {
      inicializarPagina();
      actualizarDebug('P√°gina cargada correctamente');
    });

    // Verificar autenticaci√≥n
    function verificarAutenticacion() {
      const userData = localStorage.getItem('userData');
      if (!userData) {
        alert('‚ùå Debes iniciar sesi√≥n para subir dise√±os');
        window.location.href = 'index.html';
        return;
      }
      actualizarDebug('Usuario autenticado correctamente');
    }

    // Ejecutar verificaci√≥n de autenticaci√≥n
    verificarAutenticacion();
  </script>
</body>
</html>