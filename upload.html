<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sube tu dise√±o - MSA Shop</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .upload-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .file-upload {
      border: 3px dashed #ff0000;
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      background: rgba(255, 0, 0, 0.1);
      margin: 20px 0;
      transition: all 0.3s;
    }
    
    .file-upload:hover {
      background: rgba(255, 0, 0, 0.2);
      border-color: #ffd700;
    }
    
    .preview-container {
      margin: 20px 0;
      text-align: center;
    }
    
    .preview-img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 10px;
      border: 3px solid #ffd700;
      box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
    }
    
    .success-message {
      background: rgba(255, 215, 0, 0.2);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border: 2px solid #ffd700;
      text-align: center;
    }
    
    .error-message {
      background: rgba(255, 0, 0, 0.2);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border: 2px solid #ff0000;
      text-align: center;
    }
    
    .no-auth-message {
      background: rgba(255, 215, 0, 0.2);
      padding: 30px;
      border-radius: 15px;
      margin: 20px 0;
      border: 2px solid #ffd700;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <h1>Sube tu dise√±o</h1>
    <div class="auth-buttons">
      <button class="btn-login" onclick="volverAlInicio()">‚Üê Volver al Inicio</button>
    </div>
  </header>

  <main>
    <div class="upload-container">
      <div class="producto-info">
        <h2>Sube tu dise√±o personalizado</h2>
        
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin: 20px 0; border: 2px solid #ff0000;">
          <p><strong>Producto:</strong> Camisa Personalizada</p>
          <p><strong>Talla:</strong> <span id="talla-info" style="color: #ffd700;">?</span></p>
          <p><strong>Precio:</strong> <span style="color: #ffd700;">$250 MXN</span></p>
        </div>

        <div id="uploadInterface">
          <div class="file-upload">
            <input type="file" id="fileInput" accept=".png,.jpg,.jpeg" style="width: 100%; padding: 15px; margin: 15px 0; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; border: 2px solid #ff0000;">
          </div>
          
          <div id="fileInfo" style="color: #ffd700; margin: 10px 0; text-align: center;"></div>
          
          <div id="previewContainer" class="preview-container" style="display: none;">
            <img id="previewImg" src="" alt="Vista previa" class="preview-img">
          </div>
          
          <button id="enviarBtn" class="comprar-btn">
            Enviar dise√±o y confirmar pedido
          </button>
        </div>

        <div id="successMessage" class="success-message" style="display: none;">
          <h3 style="color: #ffd700;">‚úÖ ¬°Pedido confirmado!</h3>
          <p>Redirigiendo a la p√°gina de confirmaci√≥n...</p>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;">
        </div>

        <div id="noAuthMessage" class="no-auth-message" style="display: none;">
          <h3 style="color: #ffd700;">‚ö†Ô∏è Sesi√≥n no encontrada</h3>
          <p style="margin: 15px 0;">Para subir un dise√±o necesitas iniciar sesi√≥n primero.</p>
          <button class="comprar-btn" onclick="volverAlInicio()">
            Ir a Iniciar Sesi√≥n
          </button>
        </div>
      </div>
    </div>
  </main>

  <img src="img/panda.png" alt="Panda MSA" class="panda-decoracion" onclick="volverAlInicio()" title="¬°Haz clic para volver al inicio! üè†">

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

  <script>
    const CLOUDINARY_CLOUD_NAME = 'dnzcup3ze';
    const CLOUDINARY_UPLOAD_PRESET = 'image_design';

    const firebaseConfig = {
      apiKey: "AIzaSyAbyiT01b_KFXhHuAY00aWybmYVEhuHvsY",
      authDomain: "msa-web-8517b.firebaseapp.com",
      projectId: "msa-web-8517b",
      storageBucket: "msa-web-8517b.firebasestorage.app",
      messagingSenderId: "607379403409",
      appId: "1:607379403409:web:tu-app-id-aqui"
    };

    let firebaseApp;
    let auth;
    try {
      firebaseApp = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      console.log('‚úÖ Firebase inicializado en upload.html');
    } catch (error) {
      console.log('‚ÑπÔ∏è Firebase ya inicializado');
    }

    function volverAlInicio() {
      window.location.href = 'index.html';
    }

    // FUNCI√ìN MEJORADA para detectar sesi√≥n
    async function verificarSesionUsuario() {
      return new Promise((resolve) => {
        if (auth) {
          // Esperar a que Firebase Auth est√© listo
          const unsubscribe = auth.onAuthStateChanged((user) => {
            unsubscribe();
            if (user) {
              console.log('‚úÖ Sesi√≥n activa detectada en upload.html:', user.email);
              resolve(user);
            } else {
              console.log('üîí No hay sesi√≥n activa en upload.html');
              resolve(null);
            }
          });
        } else {
          // Fallback a localStorage si Firebase no est√° disponible
          const userData = localStorage.getItem('userData');
          if (userData) {
            console.log('‚úÖ Usuario encontrado en localStorage');
            resolve(JSON.parse(userData));
          } else {
            console.log('üîí No se encontr√≥ usuario en localStorage');
            resolve(null);
          }
        }
      });
    }

    const urlParams = new URLSearchParams(window.location.search);
    const talla = urlParams.get('talla') || 'No especificada';

    const fileInput = document.getElementById('fileInput');
    const previewImg = document.getElementById('previewImg');
    const previewContainer = document.getElementById('previewContainer');
    const enviarBtn = document.getElementById('enviarBtn');
    const fileInfo = document.getElementById('fileInfo');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const noAuthMessage = document.getElementById('noAuthMessage');
    const uploadInterface = document.getElementById('uploadInterface');
    const tallaInfo = document.getElementById('talla-info');

    let archivoSeleccionado = null;
    let userData = null;

    function mostrarInfoPedido() {
      tallaInfo.textContent = talla;
    }

    async function cargarDatosUsuario() {
      console.log('üîç Verificando sesi√≥n de usuario...');
      const user = await verificarSesionUsuario();
      
      if (user) {
        userData = user;
        console.log('‚úÖ Usuario autenticado:', userData);
        uploadInterface.style.display = 'block';
        noAuthMessage.style.display = 'none';
      } else {
        console.warn('‚ö†Ô∏è Usuario no autenticado - mostrando mensaje');
        uploadInterface.style.display = 'none';
        noAuthMessage.style.display = 'block';
      }
    }

    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('‚ùå La imagen es demasiado grande. M√°ximo 5MB permitido.');
        fileInput.value = '';
        fileInfo.textContent = '';
        return;
      }

      if (!['image/png', 'image/jpeg', 'image/jpg'].includes(file.type)) {
        alert('‚ùå Solo se permiten archivos PNG, JPG o JPEG');
        fileInput.value = '';
        fileInfo.textContent = '';
        return;
      }

      archivoSeleccionado = file;
      
      const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
      fileInfo.textContent = `üìÅ Archivo: ${file.name} (${sizeMB} MB)`;
      fileInfo.style.color = '#ffd700';
      
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        previewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    async function subirACloudinary(archivo) {
      console.log('üì§ Iniciando subida a Cloudinary...');

      const formData = new FormData();
      formData.append('file', archivo);
      formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

      try {
        const response = await fetch(
          `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, 
          {
            method: 'POST',
            body: formData
          }
        );

        const responseData = await response.json();
        
        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${responseData.error?.message || 'Error de Cloudinary'}`);
        }

        console.log('‚úÖ Imagen subida exitosamente:', responseData.secure_url);
        return responseData.secure_url;

      } catch (error) {
        console.error('‚ùå Error en subida a Cloudinary:', error);
        throw error;
      }
    }

    enviarBtn.addEventListener('click', async function() {
      if (!archivoSeleccionado) {
        alert('‚ùå Por favor selecciona un archivo primero');
        return;
      }

      if (!userData) {
        alert('‚ùå Error: No se encontraron datos del usuario. Inicia sesi√≥n nuevamente.');
        window.location.href = 'index.html';
        return;
      }

      enviarBtn.textContent = 'Subiendo imagen...';
      enviarBtn.disabled = true;
      errorMessage.style.display = 'none';

      try {
        const cloudinaryUrl = await subirACloudinary(archivoSeleccionado);

        enviarBtn.textContent = 'Enviando informaci√≥n...';

        const userEmail = userData.email || userData.correo || 'No proporcionado';
        const userNombre = userData.nombre || userData.displayName || 'No proporcionado';
        const userTelefono = userData.telefono || 'No proporcionado';
        const userDireccion = userData.direccion || 'No proporcionada';

        const templateParams = {
          nombre: userNombre,
          email: userEmail,
          telefono: userTelefono,
          direccion: userDireccion,
          ciudad: "Guadalajara",
          codigo_postal: "45000",
          productos: `Camisa Personalizada - Talla: ${talla}`,
          total: "$250 MXN",
          fecha: new Date().toLocaleDateString('es-MX'),
          imagen_url: cloudinaryUrl,
          mensaje_adicional: `NUEVO PEDIDO CON DISE√ëO PERSONALIZADO

INFORMACI√ìN DEL CLIENTE:
Nombre: ${userNombre}
Email: ${userEmail}
Tel√©fono: ${userTelefono}
Direcci√≥n: ${userDireccion}

DETALLES DEL PEDIDO:
Producto: Camisa Personalizada
Talla: ${talla}
Precio: $250 MXN
Fecha: ${new Date().toLocaleDateString('es-MX')}

üé® DISE√ëO SUBIDO:
El cliente ha subido un dise√±o personalizado. Puedes verlo en:
${cloudinaryUrl}`
        };

        console.log('üìß Enviando email...');
        await emailjs.init("PhV4Hp36EPOLiGe6t");
        await emailjs.send("service_4450mrz", "template_biyacaa", templateParams);

        successMessage.style.display = 'block';
        enviarBtn.style.display = 'none';
        
        console.log('‚úÖ Pedido completado exitosamente');
        
        setTimeout(() => {
          window.location.href = 'gracias.html';
        }, 2000);

      } catch (error) {
        console.error('‚ùå Error en el proceso:', error);
        
        let mensajeError = error.message;
        
        if (error.message.includes('401')) {
          mensajeError = 'Error 401: El Upload Preset "image_design" no existe o no est√° configurado como "unsigned". Ve a Cloudinary Console para verificarlo.';
        }
        
        errorMessage.textContent = mensajeError;
        errorMessage.style.display = 'block';
        
        enviarBtn.textContent = 'Enviar dise√±o y confirmar pedido';
        enviarBtn.disabled = false;
      }
    });

    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Inicializando p√°gina upload.html');
      mostrarInfoPedido();
      await cargarDatosUsuario();
    });
  </script>
</body>
</html>