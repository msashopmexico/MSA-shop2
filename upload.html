<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sube tu dise√±o - MSA Shop</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Sube tu dise√±o</h1>
    <div class="auth-buttons">
      <button class="btn-login" onclick="volverAlInicio()">‚Üê Volver al Inicio</button>
    </div>
  </header>

  <main>
    <div class="upload-container">
      <div class="producto-info">
        <h2>Sube tu dise√±o personalizado</h2>
        
        <div class="info-box">
          <p><strong>Producto:</strong> Camisa Personalizada</p>
          <p><strong>Talla:</strong> <span id="talla-info">?</span></p>
          <p><strong>Precio:</strong> $250 MXN</p>
        </div>

        <div id="uploadInterface">
          <div class="file-upload">
            <input type="file" id="fileInput" accept=".png,.jpg,.jpeg" style="width: 100%; padding: 15px; border: 2px dashed #2d3436; border-radius: 8px; background: rgba(45, 52, 54, 0.05); cursor: pointer;">
          </div>
          
          <div id="fileInfo" style="text-align: center; margin: 15px 0; color: #2d3436; font-weight: 600;"></div>
          
          <div id="previewContainer" class="preview-container" style="display: none;">
            <img id="previewImg" src="" alt="Vista previa" class="preview-img">
          </div>
          
          <button id="enviarBtn" class="comprar-btn" style="margin-top: 20px;">
            Enviar dise√±o y confirmar pedido
          </button>
        </div>

        <div id="successMessage" class="success-message" style="display: none;">
          <h3>‚úÖ ¬°Pedido confirmado!</h3>
          <p>Redirigiendo a la p√°gina de confirmaci√≥n...</p>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;">
          <h3>‚ùå Error</h3>
          <p id="errorText"></p>
        </div>

        <div id="noAuthMessage" class="no-auth-message" style="display: none;">
          <h3>‚ö†Ô∏è Sesi√≥n no encontrada</h3>
          <p>Para subir un dise√±o necesitas iniciar sesi√≥n primero.</p>
          <button class="comprar-btn" onclick="volverAlInicio()">
            Ir a Iniciar Sesi√≥n
          </button>
        </div>
      </div>
    </div>
  </main>

  <img src="img/panda.png" alt="Panda MSA" class="panda-decoracion" onclick="volverAlInicio()" title="¬°Haz clic para volver al inicio! üè†">

  <script>
    // Configuraci√≥n
    const CLOUDINARY_CLOUD_NAME = 'dnzcup3ze';
    const CLOUDINARY_UPLOAD_PRESET = 'image_design';

    // Funci√≥n para volver al inicio
    function volverAlInicio() {
      window.location.href = 'index.html';
    }

    // Obtener datos del usuario
    function obtenerDatosUsuario() {
      try {
        const userData = localStorage.getItem('userData');
        if (userData) {
          return JSON.parse(userData);
        }
        return null;
      } catch (error) {
        console.error('Error obteniendo datos:', error);
        return null;
      }
    }

    // Elementos DOM
    const urlParams = new URLSearchParams(window.location.search);
    const talla = urlParams.get('talla') || 'No especificada';

    const fileInput = document.getElementById('fileInput');
    const previewImg = document.getElementById('previewImg');
    const previewContainer = document.getElementById('previewContainer');
    const enviarBtn = document.getElementById('enviarBtn');
    const fileInfo = document.getElementById('fileInfo');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const noAuthMessage = document.getElementById('noAuthMessage');
    const uploadInterface = document.getElementById('uploadInterface');
    const tallaInfo = document.getElementById('talla-info');

    let archivoSeleccionado = null;
    let userData = null;

    // Mostrar informaci√≥n del pedido
    function mostrarInfoPedido() {
      tallaInfo.textContent = talla;
    }

    // Cargar datos del usuario
    function cargarDatosUsuario() {
      userData = obtenerDatosUsuario();
      
      if (userData) {
        console.log('Usuario autenticado:', userData);
        uploadInterface.style.display = 'block';
        noAuthMessage.style.display = 'none';
      } else {
        console.log('Usuario no autenticado');
        uploadInterface.style.display = 'none';
        noAuthMessage.style.display = 'block';
      }
    }

    // Evento para seleccionar archivo
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      // Validar tama√±o (5MB m√°ximo)
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        mostrarError('‚ùå La imagen es demasiado grande. M√°ximo 5MB permitido.');
        fileInput.value = '';
        fileInfo.textContent = '';
        return;
      }

      // Validar tipo de archivo
      if (!['image/png', 'image/jpeg', 'image/jpg'].includes(file.type)) {
        mostrarError('‚ùå Solo se permiten archivos PNG, JPG o JPEG');
        fileInput.value = '';
        fileInfo.textContent = '';
        return;
      }

      archivoSeleccionado = file;
      
      // Mostrar informaci√≥n del archivo
      const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
      fileInfo.textContent = `üìÅ Archivo: ${file.name} (${sizeMB} MB)`;
      fileInfo.style.color = '#2d3436';
      
      // Mostrar vista previa
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        previewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    // Funci√≥n para mostrar errores
    function mostrarError(mensaje) {
      errorText.textContent = mensaje;
      errorMessage.style.display = 'block';
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 5000);
    }

    // Funci√≥n para subir a Cloudinary (simulada)
    async function subirACloudinary(archivo) {
      console.log('Subiendo a Cloudinary...');
      
      // Simular subida exitosa
      return new Promise((resolve) => {
        setTimeout(() => {
          const urlSimulada = 'https://ejemplo.com/imagen-subida.jpg';
          console.log('‚úÖ Imagen subida (simulaci√≥n):', urlSimulada);
          resolve(urlSimulada);
        }, 2000);
      });
    }

    // Evento para enviar el dise√±o
    enviarBtn.addEventListener('click', async function() {
      if (!archivoSeleccionado) {
        mostrarError('‚ùå Por favor selecciona un archivo primero');
        return;
      }

      if (!userData) {
        mostrarError('‚ùå Error: No se encontraron datos del usuario');
        return;
      }

      // Deshabilitar bot√≥n y mostrar loading
      enviarBtn.textContent = 'Subiendo imagen...';
      enviarBtn.disabled = true;
      errorMessage.style.display = 'none';

      try {
        // 1. Subir imagen a Cloudinary
        const cloudinaryUrl = await subirACloudinary(archivoSeleccionado);

        // 2. Simular env√≠o de email
        enviarBtn.textContent = 'Enviando informaci√≥n...';
        
        // Simular env√≠o exitoso
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        console.log('‚úÖ Pedido completado exitosamente');
        successMessage.style.display = 'block';
        enviarBtn.style.display = 'none';
        
        // Redirigir despu√©s de 2 segundos
        setTimeout(() => {
          window.location.href = 'gracias.html';
        }, 2000);

      } catch (error) {
        console.error('‚ùå Error en el proceso:', error);
        mostrarError('Error al procesar el pedido: ' + error.message);
        
        // Restaurar bot√≥n
        enviarBtn.textContent = 'Enviar dise√±o y confirmar pedido';
        enviarBtn.disabled = false;
      }
    });

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Inicializando p√°gina upload.html');
      mostrarInfoPedido();
      cargarDatosUsuario();
    });
  </script>
</body>
</html>