<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sube tu dise√±o - MSA Shop</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Sube tu dise√±o</h1>
    <div style="position: absolute; top: 20px; right: 30px;">
      <button onclick="volverAlInicio()" style="background: #3498db; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
        ‚Üê Volver al Inicio
      </button>
    </div>
  </header>

  <main>
    <div class="producto">
      <div class="producto-info">
        <h2>Sube tu dise√±o personalizado</h2>
        
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin: 20px 0;">
          <p><strong>Producto:</strong> Camisa Personalizada</p>
          <p><strong>Talla:</strong> <span id="talla-info">?</span></p>
          <p><strong>Precio:</strong> $250 MXN</p>
        </div>

        <!-- Panel de informaci√≥n de configuraci√≥n -->
        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin: 15px 0; font-size: 12px; color: #f39c12;">
          <strong>üîß Configuraci√≥n Cloudinary:</strong><br>
          Cloud Name: <span id="cloudNameStatus" style="color: #2ecc71;">dnzcup3ze ‚úÖ</span><br>
          Upload Preset: <span id="presetStatus" style="color: #2ecc71;">image_design ‚úÖ</span><br>
          <small>Si hay error 401, verifica que el preset "image_design" exista y sea "unsigned"</small>
        </div>

        <input type="file" id="fileInput" accept=".png,.jpg,.jpeg" style="width: 100%; padding: 12px; margin: 15px 0; border-radius: 8px; border: 2px dashed #3498db; background: rgba(255,255,255,0.1); color: white;">
        
        <div id="fileInfo" style="color: #f39c12; margin: 10px 0;"></div>
        
        <div id="previewContainer" style="display: none; text-align: center;">
          <img id="previewImg" src="" alt="Vista previa" style="max-width: 300px; border-radius: 10px; margin: 10px 0;">
        </div>
        
        <button id="enviarBtn" class="comprar-btn" style="margin-top: 20px; width: 100%;">
          Enviar dise√±o y confirmar pedido
        </button>

        <div id="successMessage" style="background: rgba(46, 204, 113, 0.2); padding: 15px; border-radius: 10px; margin: 15px 0; color: #2ecc71; display: none;">
          ‚úÖ ¬°Pedido confirmado! Redirigiendo...
        </div>

        <div id="errorMessage" style="background: rgba(231, 76, 60, 0.2); padding: 15px; border-radius: 10px; margin: 15px 0; color: #e74c3c; display: none;">
        </div>

        <!-- Instrucciones para solucionar el error 401 -->
        <div id="solucion401" style="background: rgba(243, 156, 18, 0.2); padding: 15px; border-radius: 10px; margin: 15px 0; display: none;">
          <strong>üõ†Ô∏è Para solucionar el error 401:</strong>
          <ol style="text-align: left; font-size: 12px; margin: 10px 0;">
            <li>Ve a <a href="https://cloudinary.com/console" target="_blank" style="color: #3498db;">Cloudinary Console</a></li>
            <li>Settings ‚Üí Upload ‚Üí Upload presets</li>
            <li>Busca el preset "image_design"</li>
            <li>Si no existe, crea uno nuevo con ese nombre</li>
            <li>Configura: <strong>Signing Mode = Unsigned</strong></li>
            <li>Guarda y prueba de nuevo</li>
          </ol>
        </div>
      </div>
    </div>
  </main>

  <!-- Panda decorativo -->
  <img src="img/panda.png" alt="Panda MSA" class="panda-decoracion" onclick="volverAlInicio()" title="¬°Haz clic para volver al inicio! üè†">

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <script>
    // ‚úÖ CONFIGURACI√ìN CLOUDINARY CORRECTA
    const CLOUDINARY_CLOUD_NAME = 'dnzcup3ze'; // Tu Cloud Name real
    const CLOUDINARY_UPLOAD_PRESET = 'image_design'; // Tu Upload Preset real

    // Funci√≥n para volver al inicio
    function volverAlInicio() {
      window.location.href = 'index.html';
    }

    // Funci√≥n para obtener datos del usuario desde localStorage
    function obtenerDatosUsuario() {
      try {
        const userData = localStorage.getItem('userData');
        if (userData) {
          return JSON.parse(userData);
        }
        
        const keys = Object.keys(localStorage);
        for (let key of keys) {
          if (key.startsWith('userData_')) {
            const data = localStorage.getItem(key);
            if (data) {
              return JSON.parse(data);
            }
          }
        }
        
        console.warn('‚ö†Ô∏è No se encontraron datos del usuario en localStorage');
        return null;
      } catch (error) {
        console.error('‚ùå Error obteniendo datos del usuario:', error);
        return null;
      }
    }

    // Elementos DOM
    const urlParams = new URLSearchParams(window.location.search);
    const talla = urlParams.get('talla') || 'No especificada';

    const fileInput = document.getElementById('fileInput');
    const previewImg = document.getElementById('previewImg');
    const previewContainer = document.getElementById('previewContainer');
    const enviarBtn = document.getElementById('enviarBtn');
    const fileInfo = document.getElementById('fileInfo');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const solucion401 = document.getElementById('solucion401');
    const tallaInfo = document.getElementById('talla-info');

    let archivoSeleccionado = null;
    let userData = null;

    // Mostrar informaci√≥n del pedido
    function mostrarInfoPedido() {
      tallaInfo.textContent = talla;
    }

    // Cargar datos del usuario al iniciar
    function cargarDatosUsuario() {
      userData = obtenerDatosUsuario();
      if (userData) {
        console.log('‚úÖ Datos del usuario cargados:', userData);
      } else {
        console.warn('‚ö†Ô∏è Usuario no autenticado o datos no encontrados');
        alert('‚ùå Debes iniciar sesi√≥n para continuar');
        window.location.href = 'index.html';
      }
    }

    // Configurar evento del file input
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      // Verificar tama√±o m√°ximo
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('‚ùå La imagen es demasiado grande. M√°ximo 5MB permitido.');
        fileInput.value = '';
        fileInfo.textContent = '';
        return;
      }

      if (!['image/png', 'image/jpeg', 'image/jpg'].includes(file.type)) {
        alert('‚ùå Solo se permiten archivos PNG, JPG o JPEG');
        fileInput.value = '';
        fileInfo.textContent = '';
        return;
      }

      archivoSeleccionado = file;
      
      // Mostrar informaci√≥n del archivo
      const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
      fileInfo.textContent = `Archivo: ${file.name} (${sizeMB} MB)`;
      
      // Mostrar vista previa
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        previewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    // Funci√≥n para subir imagen a Cloudinary
    async function subirACloudinary(archivo) {
      console.log('üì§ Iniciando subida a Cloudinary...', {
        cloudName: CLOUDINARY_CLOUD_NAME,
        uploadPreset: CLOUDINARY_UPLOAD_PRESET,
        fileName: archivo.name,
        fileSize: archivo.size
      });

      const formData = new FormData();
      formData.append('file', archivo);
      formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

      try {
        const response = await fetch(
          `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, 
          {
            method: 'POST',
            body: formData
          }
        );

        const responseData = await response.json();
        
        if (!response.ok) {
          console.error('‚ùå Error respuesta Cloudinary:', {
            status: response.status,
            data: responseData
          });
          
          if (response.status === 401) {
            throw new Error('401: Upload Preset "image_design" no encontrado o no es "unsigned". Verifica en Cloudinary Console.');
          }
          throw new Error(`Error ${response.status}: ${responseData.error?.message || 'Error de Cloudinary'}`);
        }

        console.log('‚úÖ Imagen subida exitosamente:', responseData.secure_url);
        return responseData.secure_url;

      } catch (error) {
        console.error('‚ùå Error en subida a Cloudinary:', error);
        throw error;
      }
    }

    // Funci√≥n principal para enviar el pedido
    enviarBtn.addEventListener('click', async function() {
      if (!archivoSeleccionado) {
        alert('‚ùå Por favor selecciona un archivo primero');
        return;
      }

      if (!userData) {
        alert('‚ùå Error: No se encontraron datos del usuario. Inicia sesi√≥n nuevamente.');
        window.location.href = 'index.html';
        return;
      }

      // Deshabilitar bot√≥n y mostrar loading
      enviarBtn.textContent = 'Subiendo imagen...';
      enviarBtn.disabled = true;
      errorMessage.style.display = 'none';
      solucion401.style.display = 'none';

      try {
        // 1. Subir imagen a Cloudinary
        const cloudinaryUrl = await subirACloudinary(archivoSeleccionado);

        // 2. Enviar email con EmailJS
        enviarBtn.textContent = 'Enviando informaci√≥n...';

        const templateParams = {
          nombre: userData.nombre || "No proporcionado",
          email: userData.email || "No proporcionado",
          telefono: userData.telefono || "No proporcionado",
          direccion: userData.direccion || "No proporcionada",
          ciudad: "Guadalajara",
          codigo_postal: "45000",
          productos: `Camisa Personalizada - Talla: ${talla}`,
          total: "$250 MXN",
          fecha: new Date().toLocaleDateString('es-MX'),
          imagen_url: cloudinaryUrl,
          mensaje_adicional: `NUEVO PEDIDO CON DISE√ëO PERSONALIZADO

INFORMACI√ìN DEL CLIENTE:
Nombre: ${userData.nombre}
Email: ${userData.email}
Tel√©fono: ${userData.telefono}
Direcci√≥n: ${userData.direccion}

DETALLES DEL PEDIDO:
Producto: Camisa Personalizada
Talla: ${talla}
Precio: $250 MXN
Fecha: ${new Date().toLocaleDateString('es-MX')}

üé® DISE√ëO SUBIDO:
El cliente ha subido un dise√±o personalizado. Puedes verlo en:
${cloudinaryUrl}`
        };

        console.log('üìß Enviando email...');
        await emailjs.init("PhV4Hp36EPOLiGe6t");
        await emailjs.send("service_4450mrz", "template_biyacaa", templateParams);

        // √âxito
        successMessage.style.display = 'block';
        enviarBtn.style.display = 'none';
        
        console.log('‚úÖ Pedido completado exitosamente');
        
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);

      } catch (error) {
        console.error('‚ùå Error en el proceso:', error);
        
        let mensajeError = error.message;
        
        if (error.message.includes('401')) {
          mensajeError = 'Error 401: El Upload Preset "image_design" no existe o no est√° configurado como "unsigned".';
          solucion401.style.display = 'block';
        }
        
        errorMessage.textContent = mensajeError;
        errorMessage.style.display = 'block';
        
        // Restaurar bot√≥n
        enviarBtn.textContent = 'Enviar dise√±o y confirmar pedido';
        enviarBtn.disabled = false;
      }
    });

    // Inicializar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      mostrarInfoPedido();
      cargarDatosUsuario();
      console.log('üîß Configuraci√≥n Cloudinary:', {
        cloudName: CLOUDINARY_CLOUD_NAME,
        uploadPreset: CLOUDINARY_UPLOAD_PRESET
      });
    });
  </script>
</body>
</html>